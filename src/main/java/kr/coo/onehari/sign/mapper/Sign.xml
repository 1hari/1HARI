<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
작성자: 김정하
시작: 2020. 1. 13
완료: 
내용: 문서기안 작업 시작
-->
<mapper namespace="kr.coo.onehari.sign.dao.SignDao">

	<!-- 문서기안 등록하기 김정하 / 2020. 1. 13-->
	<insert id="insertSign">
		INSERT INTO sign (DRAFTEMP, EMPSIGN1, EMPSIGN2, SIGNFORMCODE, SIGNTITLE, SIGNCONTENT, SIGNFILENAME, SIGNFILEROOT)
		VALUES (
			#{draftEmp}, <!-- 기안자 -->
			#{empSign1}, <!-- 결재자1 -->
			#{empSign2}, <!-- 결재자1 -->
			#{signFormCode}, <!-- 문서양식 코드 -->
			#{signTitle}, <!-- 결재자1 -->
			#{signContent}, <!-- 결재내용 -->
			#{signFileName}, <!-- 첨부파일명 -->
			#{signFileRoot} <!-- 첨부파일경로 -->
		)
	</insert>
	
	<!-- 내 문서함 페이징 다이나믹쿼리 김정하 / 2020. 1 15 -->
	<select id="signPage" parameterType="hashmap" resultType="int">
		SELECT COUNT(SIGNNUM) FROM sign
		<where>
			<choose>
				<when test="code.equalsIgnoreCase('0')"> <!-- 전체문서 -->
					if(ISSIGN1 = 0, EMPSIGN1 = #{draftEmp}, EMPSIGN2 = #{draftEmp}) OR DRAFTEMP = #{draftEmp}
				</when>
				<when test="code.equalsIgnoreCase('1')"> <!-- 기안문서 -->
					SIGNCODE IN(1,2) AND DRAFTEMP = #{draftEmp}
				</when>
				<when test='code == "2"'> <!-- 완료문서 -->
					SIGNCODE = 3 AND DRAFTEMP = #{draftEmp}
				</when>
				<when test='code == "3"'> <!-- 반려문서 -->
					SIGNCODE = 4 AND DRAFTEMP = #{draftEmp}
				</when>
				<when test='code == "4"'> <!-- 결재할 문서-->
					SIGNCODE IN(1,2) AND if(ISSIGN1 = 0, EMPSIGN1 = #{draftEmp}, EMPSIGN2 = #{draftEmp})
				</when>
			</choose>
		</where>
	</select>
	
	<!-- 전자결재 리스트 다이나믹 쿼리로 변경해보기 김정하 / 2020. 1.14 -->
	<select id="selectSignList" parameterType="hashmap" resultType="kr.coo.onehari.sign.dto.SignDto">
				<!-- 문서번호, 문서양식명, 결재구분코드, 결재구분명 , 제목,  작성일 -->
		SELECT s.SIGNNUM,f.SIGNFORMFORMNAME, s.SIGNCODE, t.SIGNNAME, s.SIGNTITLE, s.SIGNDATE,
				<!-- 기안자,결재자1, 결재자2 -->
				s.DRAFTEMP, e.EMPNAME as draftEmpName, s.EMPSIGN1, e2.EMPNAME AS empSign1Name, s.EMPSIGN2, e3.EMPNAME AS empSign2Name,
				<!-- 내용, 첨부파일명, 경로, 결재여부1, 결재여부2, 코멘트 -->
				s.SIGNCONTENT, s.SIGNFILENAME, s.SIGNFILEROOT, s.ISSIGN1, s.ISSIGN2, s.SIGNCOMMENT
		FROM sign s JOIN signform f 
						ON s.SIGNFORMCODE = f.SIGNFORMCODE
					JOIN signtype t
						ON s.SIGNCODE = t.SIGNCODE
					JOIN emp e
						ON s.DRAFTEMP = e.EMPNUM
		<where>
			<choose>
				<when test="code.equalsIgnoreCase('0')"> <!-- 전체문서 -->
					s.DRAFTEMP = #{draftEmp} OR if(s.ISSIGN1 = 0, s.EMPSIGN1 = #{draftEmp}, s.EMPSIGN2 = #{draftEmp})
				</when>
				<when test="code.equalsIgnoreCase('1')"> <!-- 기안문서 -->
					s.SIGNCODE IN(1,2) AND s.DRAFTEMP = #{draftEmp}
				</when>
				<when test='code == "2"'> <!-- 완료문서 -->
					s.SIGNCODE = 3 AND s.DRAFTEMP = #{draftEmp}
				</when>
				<when test='code == "3"'> <!-- 반려문서 -->
					s.SIGNCODE = 4 AND s.DRAFTEMP = #{draftEmp}
				</when>
				<when test='code == "4"'> <!-- 결재할 문서-->
					s.SIGNCODE IN(1,2) AND if(s.ISSIGN1 = 0, s.EMPSIGN1 = #{draftEmp}, s.EMPSIGN2 = #{draftEmp})
				</when>
			</choose>
		</where>				
		ORDER BY s.SIGNDATE DESC
		LIMIT ${pg}
		<if test="cp != '0'">
			OFFSET ${cp}
		</if>
	</select>
	
</mapper>